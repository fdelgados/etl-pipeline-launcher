version: "3"

services:
  mariadb:
    image: mariadb:10.4.21
    restart: always
    environment:
      - MYSQL_ROOT_HOST
      - MYSQL_ROOT_PASSWORD
    ports:
      - "33006:3306"
    volumes:
      - ../resources/databases:/docker-entrypoint-initdb.d
      - ../.mariadb-data:/var/lib/mysql

  application:
    image: nlp-application
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        - REQUIREMENTS_FILE=${REQUIREMENTS_FILE}
    depends_on:
      - mariadb
      - rabbitmq
      - redis
      - mailhog
      - mongo
    volumes:
      - ../src:/var/www/src
      - ../tests:/var/www/tests
      - ../config:/var/www/config
      - ../export:/export
      - ../log:/log
      - ../bin:/var/www/bin
      - ../.data:/var/www/data
    restart: always
    env_file: ./.env
    ports:
      - "5000:5000"
    command: gunicorn --bind 0.0.0.0:5000 shared.infrastructure.flask.entrypoint.run:app

  worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    command: /var/www/bin/run_workers.py
    depends_on:
      - rabbitmq
      - redis
      - mailhog
      - mongo
    environment:
      - ENVIRONMENT

  static-analysis:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    command: flake8 --ignore=E203,W503 .
    environment:
      - REQUIREMENTS_FILE

  rabbitmq:
    image: rabbitmq:3-management-alpine
    restart: always
    environment:
      - RABBITMQ_USER
      - RABBITMQ_PASSWORD
    ports:
      - "5672:5672"
      - "15672:15672"

  redis:
    image: redis:3.2.12
    command: [ "redis-server", "--appendonly", "yes" ]
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - ../.redis-data:/redis-data

  mailhog:
    image: mailhog/mailhog
    ports:
      - "1025:1025"
      - "8025:8025"

  mongo:
    image: mongo:5.0-focal
    restart: always
    ports:
      - "27017:27017"
    env_file: ./.env
    volumes:
      - ../resources/mongodb/mongo-init.sh:/docker-entrypoint-initdb.d/mongo-init.sh
      - ../.mongodb-data:/data/db
